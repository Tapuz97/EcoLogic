<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Parser Test</title>
    <link rel="stylesheet" href="/assets/css/style_light.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #4cd469;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45b85a;
        }
        .result-area {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-good { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Data Parser Testing Interface</h1>
        <p>This page tests the data transformation from raw Firebase reports to statistical formats.</p>

        <div class="test-section">
            <h2>üìä Data Parser Status</h2>
            <button class="test-button" onclick="checkParserStatus()">Check Parser Status</button>
            <div id="status-result" class="result-area"></div>
        </div>

        <div class="test-section">
            <h2>üîç Raw Reports Data</h2>
            <button class="test-button" onclick="fetchRawReports()">Fetch Raw Reports</button>
            <div id="reports-result" class="result-area"></div>
        </div>

        <div class="test-section">
            <h2>üßÆ Statistical Transformations</h2>
            <button class="test-button" onclick="testTransformation('t-test-depth')">T-Test Depth</button>
            <button class="test-button" onclick="testTransformation('anova-beach')">ANOVA Beach</button>
            <button class="test-button" onclick="testTransformation('anova-habitat')">ANOVA Habitat</button>
            <button class="test-button" onclick="testTransformation('regression-water')">Regression Water</button>
            <button class="test-button" onclick="testTransformation('chi-species')">Chi-Square Species</button>
            <button class="test-button" onclick="testTransformation('kriging-map')">Kriging Map</button>
            <div id="transform-result" class="result-area"></div>
        </div>

        <div class="test-section">
            <h2>üöÄ Data Processing</h2>
            <button class="test-button" onclick="processAllData()">Process All Statistical Data</button>
            <button class="test-button" onclick="checkStatsEndpoints()">Check Stats Endpoints</button>
            <div id="processor-result" class="result-area"></div>
        </div>

        <div class="test-section">
            <h2>üìà StatsCharts.js Integration</h2>
            <button class="test-button" onclick="testStatsAPI()">Test Stats API Directly</button>
            <button class="test-button" onclick="testChartIntegration()">Test Chart Integration</button>
            <div id="chart-result" class="result-area"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'status-error' : 
                            type === 'success' ? 'status-good' : 
                            type === 'warning' ? 'status-warning' : '';
            
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkParserStatus() {
            clearLog('status-result');
            log('status-result', 'üîÑ Checking data parser status...', 'info');
            
            try {
                const response = await fetch('/api/data-parser');
                if (response.ok) {
                    const data = await response.json();
                    log('status-result', '‚úÖ Parser is online', 'success');
                    log('status-result', `üìä Total reports: ${data.totalReports}`, 'info');
                    log('status-result', `üîó Available endpoints: ${data.availableEndpoints.length}`, 'info');
                    data.availableEndpoints.forEach(endpoint => {
                        log('status-result', `   ‚Ä¢ ${endpoint}`, 'info');
                    });
                } else {
                    log('status-result', `‚ùå Parser error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('status-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function fetchRawReports() {
            clearLog('reports-result');
            log('reports-result', 'üîÑ Fetching raw reports data...', 'info');
            
            try {
                const response = await fetch('/api/reports?limit=10');
                if (response.ok) {
                    const data = await response.json();
                    log('reports-result', `‚úÖ Fetched ${data.reports.length} reports`, 'success');
                    
                    data.reports.slice(0, 3).forEach((report, i) => {
                        log('reports-result', `üìÑ Report ${i+1}: ${report.species} at ${report.where} (${report.status})`, 'info');
                    });
                    
                    log('reports-result', `üíæ Full data available in browser console`, 'info');
                    console.log('Raw Reports Data:', data);
                } else {
                    log('reports-result', `‚ùå Reports error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('reports-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function testTransformation(endpoint) {
            clearLog('transform-result');
            log('transform-result', `üîÑ Testing transformation: ${endpoint}...`, 'info');
            
            try {
                const response = await fetch('/api/data-parser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint: endpoint,
                        source: 'scientist',
                        field: 'density_per_m2',
                        grid: 160
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('transform-result', `‚úÖ ${endpoint} transformation successful`, 'success');
                    log('transform-result', `üìä Data type: ${result.data.test || endpoint}`, 'info');
                    
                    if (result.data.p_value) {
                        log('transform-result', `üßÆ P-value: ${result.data.p_value} (${result.data.significant ? 'significant' : 'not significant'})`, 'info');
                    }
                    
                    if (result.data.n || result.data.points) {
                        log('transform-result', `üìà Sample size: ${result.data.n || result.data.points}`, 'info');
                    }
                    
                    log('transform-result', `üíæ Full data available in browser console`, 'info');
                    console.log(`${endpoint} transformation result:`, result.data);
                } else {
                    log('transform-result', `‚ùå Transformation failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('transform-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function processAllData() {
            clearLog('processor-result');
            log('processor-result', 'üîÑ Processing all statistical data...', 'info');
            
            try {
                const response = await fetch('/api/data-parser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ processAll: true })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('processor-result', '‚úÖ All data processed successfully', 'success');
                    log('processor-result', `üìä Processed ${result.totalReports} reports`, 'info');
                    
                    Object.entries(result.results).forEach(([endpoint, status]) => {
                        const statusType = status === 'success' ? 'success' : 'error';
                        log('processor-result', `   ‚Ä¢ ${endpoint}: ${status}`, statusType);
                    });
                    
                    log('processor-result', `‚è∞ Completed at: ${new Date(result.timestamp).toLocaleTimeString()}`, 'info');
                } else {
                    log('processor-result', `‚ùå Processing failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('processor-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        async function checkStatsEndpoints() {
            clearLog('processor-result');
            log('processor-result', 'ÔøΩ Checking stats endpoints...', 'info');
            
            const endpoints = ['t_test_depth', 'anova_beach', 'anova_habitat', 'regression_waterlevel', 'chi_species_by', 'kriging_map'];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`/api/stats?endpoint=${endpoint}`);
                    if (response.ok) {
                        const data = await response.json();
                        log('processor-result', `‚úÖ ${endpoint}: Data available`, 'success');
                    } else if (response.status === 204) {
                        log('processor-result', `‚ö†Ô∏è ${endpoint}: No data - run processor first`, 'warning');
                    } else {
                        log('processor-result', `‚ùå ${endpoint}: ${response.statusText}`, 'error');
                    }
                } catch (error) {
                    log('processor-result', `‚ùå ${endpoint}: ${error.message}`, 'error');
                }
            }
        }

        async function testStatsAPI() {
            clearLog('chart-result');
            log('chart-result', 'üìä Testing stats API directly...', 'info');
            
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const data = await response.json();
                    log('chart-result', '‚úÖ Stats API is working', 'success');
                    log('chart-result', `üìÖ Last updated: ${data.last_updated || 'Never'}`, 'info');
                    log('chart-result', `ÔøΩ Available endpoints: ${data.available_endpoints.length}`, 'info');
                    
                    data.available_endpoints.forEach(endpoint => {
                        log('chart-result', `   ‚Ä¢ /api/stats?endpoint=${endpoint}`, 'info');
                    });
                } else {
                    log('chart-result', `‚ùå Stats API error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log('chart-result', `‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        function testChartIntegration() {
            clearLog('chart-result');
            log('chart-result', 'üìà Testing chart integration...', 'info');
            
            // Check if StatsCharts.js functions are available
            if (window.renderAll) {
                log('chart-result', '‚úÖ StatsCharts.js is loaded', 'success');
                log('chart-result', 'üîÑ Triggering chart render...', 'info');
                
                try {
                    window.renderAll();
                    log('chart-result', '‚úÖ Charts rendered successfully', 'success');
                } catch (error) {
                    log('chart-result', `‚ùå Chart render error: ${error.message}`, 'error');
                }
            } else {
                log('chart-result', '‚ö†Ô∏è StatsCharts.js not loaded on this page', 'warning');
                log('chart-result', 'üí° Try this test on the analytics page', 'info');
            }
            
            // Check for Chart.js
            if (window.Chart) {
                log('chart-result', '‚úÖ Chart.js is available', 'success');
            } else {
                log('chart-result', '‚ùå Chart.js not loaded', 'error');
            }
            
            // Test actual stats endpoints that StatsCharts.js uses
            log('chart-result', 'üîç Testing StatsCharts.js endpoints...', 'info');
            const endpoints = [
                '/api/stats?endpoint=t_test_depth',
                '/api/stats?endpoint=anova_beach',
                '/api/stats?endpoint=anova_habitat',
                '/api/stats?endpoint=regression_waterlevel',
                '/api/stats?endpoint=chi_species_by',
                '/api/stats?endpoint=kriging_map'
            ];
            
            endpoints.forEach(async (url, i) => {
                try {
                    const response = await fetch(url);
                    const endpointName = url.split('=')[1];
                    if (response.ok) {
                        log('chart-result', `‚úÖ ${endpointName}: Ready for StatsCharts.js`, 'success');
                    } else if (response.status === 204) {
                        log('chart-result', `‚ö†Ô∏è ${endpointName}: No data (run processor first)`, 'warning');
                    } else {
                        log('chart-result', `‚ùå ${endpointName}: ${response.statusText}`, 'error');
                    }
                } catch (error) {
                    log('chart-result', `‚ùå ${endpointName}: ${error.message}`, 'error');
                }
            });
        }

        // Auto-run basic checks when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkParserStatus();
            }, 1000);
        });
    </script>
</body>
</html>